name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Debug info
      run: |
        echo "Python version: $(python --version)"
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "src contents:"
        ls -la src/ || echo "No src directory"
        echo "tests contents:"
        ls -la tests/ || echo "No tests directory"
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Устанавливаем pydantic первой
        pip install pydantic PyYAML
        # Затем остальное
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
    
    - name: Run tests with debug
      run: |
        echo "Running tests..."
        python -c "import sys; print('Python path:', sys.path)"
        python -c "import pydantic; print(f'Pydantic: {pydantic.__version__}')" || echo "Pydantic not installed"
        python -c "import yaml; print('PyYAML ok')" || echo "PyYAML not installed"
        
        # Запускаем тесты с подробным выводом
        pytest tests/ -v --tb=short || true
        
        # Если есть ошибки, покажем больше информации
        echo "Test files found:"
        find tests/ -name "test_*.py" -type f || echo "No test files"
    
    - name: Run specific failing tests
      if: failure()
      run: |
        echo "Debugging failing tests..."
        # Запускаем каждый тест отдельно
        for test_file in tests/test_*.py; do
          echo "=== Testing $test_file ==="
          pytest "$test_file" -v --tb=line || echo "Failed: $test_file"
        done