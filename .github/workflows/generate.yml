name: üóìÔ∏è Scheduled Test Case Generation

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      task_type:
        description: '–¢–∏–ø –∑–∞–¥–∞—á–∏'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - sorting
          - searching
          - math
      num_cases:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É—á–∞–µ–≤'
        required: false
        default: 10
        type: number
      format:
        description: '–§–æ—Ä–º–∞—Ç'
        required: false
        default: 'json'
        type: choice
        options:
          - json
          - yaml

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚¨áÔ∏è Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: üì¶ Install
      run: |
        pip install -e .
    
    - name: üß™ Generate
      id: gen
      run: |
        TIMESTAMP=$(date +"%Y-%m-%d")
        OUTPUT_DIR="weekly_cases_$TIMESTAMP"
        mkdir -p $OUTPUT_DIR
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TASK="${{ github.event.inputs.task_type }}"
          COUNT="${{ github.event.inputs.num_cases }}"
          FMT="${{ github.event.inputs.format }}"
        else
          TASK="all"
          COUNT=10
          FMT="json"
        fi
        
        echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è: $TASK, $COUNT —Å–ª—É—á–∞–µ–≤, —Ñ–æ—Ä–º–∞—Ç $FMT"
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
        if [ "$TASK" = "all" ] || [ "$TASK" = "sorting" ]; then
          python main.py sorting -n $COUNT -o "$OUTPUT_DIR/sorting.$FMT" -f $FMT
        fi
        
        if [ "$TASK" = "all" ] || [ "$TASK" = "searching" ]; then
          python main.py searching -n $COUNT -o "$OUTPUT_DIR/searching.$FMT" -f $FMT
        fi
        
        if [ "$TASK" = "all" ] || [ "$TASK" = "math" ]; then
          python main.py math -n $COUNT -o "$OUTPUT_DIR/math.$FMT" -f $FMT
        fi
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º outputs
        echo "TASK=$TASK" >> $GITHUB_OUTPUT
        echo "COUNT=$COUNT" >> $GITHUB_OUTPUT
        echo "FMT=$FMT" >> $GITHUB_OUTPUT
        echo "DIR=$OUTPUT_DIR" >> $GITHUB_OUTPUT
        echo "DATE=$TIMESTAMP" >> $GITHUB_OUTPUT
        
        echo "‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ $OUTPUT_DIR/"
    
    - name: üì§ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: "test-cases-${{ steps.gen.outputs.DATE }}"
        path: "${{ steps.gen.outputs.DIR }}/"
        retention-days: 30
    
    - name: üîÄ Create PR (scheduled only)
      if: github.event_name == 'schedule'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: add weekly test cases ${{ steps.gen.outputs.DATE }}"
        title: "Weekly test cases ${{ steps.gen.outputs.DATE }}"
        body: |
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏ –∑–∞ –Ω–µ–¥–µ–ª—é.
          
          **–î–∞—Ç–∞:** ${{ steps.gen.outputs.DATE }}
          **–¢–∏–ø—ã –∑–∞–¥–∞—á:** ${{ steps.gen.outputs.TASK }}
          **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:** ${{ steps.gen.outputs.COUNT }} –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
          
          –§–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ `${{ steps.gen.outputs.DIR }}/`
        branch: "weekly/${{ steps.gen.outputs.DATE }}"
        base: "main"