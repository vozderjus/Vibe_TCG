name: ðŸ—“ï¸ Scheduled Test Case Generation

on:
  # 1. Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ (ÐºÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 00:00 UTC)
  schedule:
    - cron: '0 0 * * 0'
  
  # 2. Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¸Ð· Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ° GitHub
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Ð¢Ð¸Ð¿ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - sorting
          - searching
          - math
      num_cases:
        description: 'ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ»ÑƒÑ‡Ð°ÐµÐ² ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð°'
        required: false
        default: 15
        type: number
      format:
        description: 'Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²'
        required: false
        default: 'json'
        type: choice
        options:
          - json
          - yaml

jobs:
  generate-weekly-cases:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
    - name: â¬‡ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ PR
    
    # 2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Python
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: 'pip'
    
    # 3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
    
    # 4. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ»ÑƒÑ‡Ð°ÐµÐ²
    - name: ðŸ§ª Generate test cases
      id: generate
      run: |
        echo "ðŸ”§ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ»ÑƒÑ‡Ð°ÐµÐ²..."
        
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
        TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
        OUTPUT_DIR="generated_$TIMESTAMP"
        mkdir -p $OUTPUT_DIR
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐºÐ°ÐºÐ¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          TASK_TYPE="${{ github.event.inputs.task_type }}"
          NUM_CASES="${{ github.event.inputs.num_cases }}"
          FORMAT="${{ github.event.inputs.format }}"
        else
          # ÐŸÑ€Ð¸ scheduled Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÑ‘
          TASK_TYPE="all"
          NUM_CASES=15
          FORMAT="json"
        fi
        
        # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¸Ð¿Ð°
        case $TASK_TYPE in
          "sorting")
            python main.py sorting -n $NUM_CASES -o $OUTPUT_DIR/sorting_cases.$FORMAT -f $FORMAT --verbose
            ;;
          "searching")
            python main.py searching -n $NUM_CASES -o $OUTPUT_DIR/searching_cases.$FORMAT -f $FORMAT --verbose
            ;;
          "math")
            python main.py math -n $NUM_CASES -o $OUTPUT_DIR/math_cases.$FORMAT -f $FORMAT --verbose
            ;;
          "all")
            python main.py sorting -n $NUM_CASES -o $OUTPUT_DIR/sorting_cases.$FORMAT -f $FORMAT --no-edge-cases
            python main.py searching -n $NUM_CASES -o $OUTPUT_DIR/searching_cases.$FORMAT -f $FORMAT --no-edge-cases
            python main.py math -n $NUM_CASES -o $OUTPUT_DIR/math_cases.$FORMAT -f $FORMAT --no-edge-cases
            ;;
        esac
        
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ README Ñ Ð¼ÐµÑ‚Ð°Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹
        cat > $OUTPUT_DIR/README.md << EOF
        # ðŸ“Š ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸
        
        **Ð”Ð°Ñ‚Ð° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸:** $TIMESTAMP
        **Ð¢Ð¸Ð¿ Ð·Ð°Ð´Ð°Ñ‡:** $TASK_TYPE
        **ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ»ÑƒÑ‡Ð°ÐµÐ²:** $NUM_CASES Ð½Ð° Ñ‚Ð¸Ð¿
        **Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚:** $FORMAT
        **Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        ## ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ
        
        $(ls -la $OUTPUT_DIR/*.$FORMAT 2>/dev/null | wc -l) Ñ„Ð°Ð¹Ð»Ð¾Ð² Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¼Ð¸ ÑÐ»ÑƒÑ‡Ð°ÑÐ¼Ð¸:
        
        $(for file in $OUTPUT_DIR/*.$FORMAT; do
          if [ -f "$file" ]; then
            BASENAME=$(basename "$file")
            COUNT=$(python -c "
import json
import yaml
import sys
try:
    with open('$file', 'r') as f:
        if '$FORMAT' == 'json':
            data = json.load(f)
        else:
            data = yaml.safe_load(f)
    print(len(data))
except:
    print('?')
")
            echo "- \`$BASENAME\` - $COUNT Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ»ÑƒÑ‡Ð°ÐµÐ²"
          fi
        done)
        
        ## ðŸ”„ ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ
        
        \`\`\`python
        # ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ JSON Ñ„Ð°Ð¹Ð»Ð°
        import json
        
        with open('$OUTPUT_DIR/sorting_cases.$FORMAT', 'r') as f:
            test_cases = json.load(f)
        
        for case in test_cases:
            print(f\"Input: {case['input']}\")
            print(f\"Expected: {case['expected']}\")
        \`\`\`
        
        ---
        *Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ [Test Case Generator](${{ github.server_url }}/${{ github.repository }})*
        EOF
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð¾Ð²
        echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_OUTPUT
        echo "TASK_TYPE=$TASK_TYPE" >> $GITHUB_OUTPUT
        echo "NUM_CASES=$NUM_CASES" >> $GITHUB_OUTPUT
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT
        
        echo "âœ… Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ $(ls $OUTPUT_DIR/*.$FORMAT 2>/dev/null | wc -l) Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² $OUTPUT_DIR/"
    
    # 5. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Pull Request Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ð¼Ð¸ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ scheduled)
    - name: ðŸ”€ Create Pull Request with new cases
      if: github.event_name == 'schedule'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ðŸ§ª test: add weekly generated test cases (${{ steps.generate.outputs.TIMESTAMP }})"
        title: "ðŸ—“ï¸ Weekly Test Case Update - ${{ steps.generate.outputs.TIMESTAMP }}"
        body: |
          ## ðŸ“Š ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ»ÑƒÑ‡Ð°ÐµÐ²
          
          Ð­Ñ‚Ð¾Ñ‚ PR ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸ Ð½Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ.
          
          **Ð”ÐµÑ‚Ð°Ð»Ð¸:**
          - **Ð”Ð°Ñ‚Ð° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸:** ${{ steps.generate.outputs.TIMESTAMP }}
          - **Ð¢Ð¸Ð¿Ñ‹ Ð·Ð°Ð´Ð°Ñ‡:** ${{ steps.generate.outputs.TASK_TYPE }}
          - **ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ»ÑƒÑ‡Ð°ÐµÐ²:** ${{ steps.generate.outputs.NUM_CASES }} ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð°
          - **Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### ðŸ“ Ð§Ñ‚Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾:
          - Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ ÑÐ²ÐµÐ¶Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸ Ð² Ð¿Ð°Ð¿ÐºÑƒ `${{ steps.generate.outputs.OUTPUT_DIR }}/`
          - Ð’ÑÐµ ÑÐ»ÑƒÑ‡Ð°Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ñ‹ Ð½Ð° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ
          - Edge cases Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸
          
          ### ðŸš€ ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:
          1. Ð¤Ð°Ð¹Ð»Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð² Ð¿Ð°Ð¿ÐºÐµ `${{ steps.generate.outputs.OUTPUT_DIR }}/`
          2. Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‹: JSON Ð¸ YAML
          3. ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
          
          ---
          *Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ [Test Case Generator](${{ github.server_url }}/${{ github.repository }})*
        branch: "weekly-cases-${{ steps.generate.outputs.TIMESTAMP }}"
        base: "main"
        labels: "automated, test-cases, weekly-update"
        
    # 6. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² (Ð²ÑÐµÐ³Ð´Ð°)
    - name: ðŸ“¤ Upload generated cases as artifact
      uses: actions/upload-artifact@v4
      with:
        name: "test-cases-${{ steps.generate.outputs.TIMESTAMP }}"
        path: |
          ${{ steps.generate.outputs.OUTPUT_DIR }}/
        retention-days: 30
        if-no-files-found: error
    
    # 7. Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ)
    - name: ðŸ“¢ Notification summary
      if: always()
      run: |
        echo "## ðŸ§ª Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Ð¢Ð¸Ð¿ Ð·Ð°Ð¿ÑƒÑÐºÐ°:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾:** ${{ steps.generate.outputs.TASK_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "**ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚:** test-cases-${{ steps.generate.outputs.TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Ð’Ð¾Ð·Ð½Ð¸ÐºÐ»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¿Ñ€Ð¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸" >> $GITHUB_STEP_SUMMARY
        fi